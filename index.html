<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dostava - Predaja Pazara</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============ LOCAL STORAGE HELPERS ============
        const STORAGE_KEYS = {
            USERS: 'dostava_users',
            SHIFTS: 'dostava_shifts',
            SUBMISSIONS: 'dostava_submissions',
            SAFE_TRANSACTIONS: 'dostava_safe_transactions',
            SAFE_CONTROLS: 'dostava_safe_controls'
        };

        const saveToStorage = (key, data) => {
            localStorage.setItem(key, JSON.stringify(data));
            window.dispatchEvent(new StorageEvent('storage', { key, newValue: JSON.stringify(data) }));
        };

        const loadFromStorage = (key, defaultValue) => {
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : defaultValue;
        };

        // ============ IKONE ============
        const Icon = ({name, size=24}) => {
            const icons = {
                wallet: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
                user: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                truck: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 18H3V7h10v11M14 9h4l4 4v4h-2M7 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM17 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>,
                shield: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
                logout: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>,
                clock: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>,
                mapPin: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
                chevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18l6-6-6-6"/></svg>,
                arrowLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>,
                check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 6L9 17l-5-5"/></svg>,
                x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>,
                bell: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
                plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>,
                minus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/></svg>,
                banknote: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="12" cy="12" r="2"/></svg>,
                safe: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M12 9v6M9 12h6"/></svg>,
                clipboardCheck: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>,
                arrowUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg>,
                arrowDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>,
                package: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16.5 9.4L7.5 4.21M21 16V8l-9-5-9 5v8l9 5 9-5zM3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/></svg>,
                building: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18zM6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/></svg>,
                users: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
                barChart: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20V10M18 20V4M6 20v-4"/></svg>,
                calendar: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
                fileText: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>,
                edit: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
                trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                headphones: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg>,
                refresh: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            };
            return icons[name] || null;
        };

        // ============ PODACI ============
        const DELIVERY_LOCATIONS = [
            { id: 'KANCELARIJA', name: 'Kancelarija', short: 'KAN' },
            { id: 'MP-PAL', name: 'Palačinkarnica', short: 'PAL' },
            { id: 'MP-P47', name: 'Požeška 47', short: 'P-47' },
            { id: 'MP-P96', name: 'Požeška 96', short: 'P-96' },
            { id: 'MP-NBG', name: 'Novi Beograd', short: 'NBG' },
            { id: 'MP-DRA', name: 'Dravska', short: 'DRA' },
            { id: 'PRO-PEK', name: 'Pekara', short: 'PEK' },
            { id: 'FOOD-TRUCK', name: 'Food Truck', short: 'FT' },
        ];

        const ROLES = [
            { id: 'driver', name: 'Vozač', icon: 'truck' },
            { id: 'dispatcher', name: 'Dispecer', icon: 'headphones' },
            { id: 'admin', name: 'Admin', icon: 'shield' },
        ];

        const DEFAULT_USERS = [
            { id: 1, pin: '1001', name: 'Denis Fejza', role: 'driver', phone: '069/250-32-29' },
            { id: 2, pin: '1002', name: 'Lazar Jovanović', role: 'driver', phone: '062/703-416' },
            { id: 3, pin: '1003', name: 'Zlatko Perkunić', role: 'driver', phone: '063/258-881' },
            { id: 4, pin: '1004', name: 'Alen Ramadanović', role: 'driver', phone: '064/906-75-86' },
            { id: 5, pin: '1005', name: 'Goran Đorđević', role: 'driver', phone: '064/286-89-83' },
            { id: 6, pin: '2001', name: 'Milica Minović', role: 'dispatcher' },
            { id: 7, pin: '2002', name: 'Nataša Dragutinović', role: 'dispatcher' },
            { id: 8, pin: '2003', name: 'Marija Tamindžić', role: 'dispatcher' },
            { id: 9, pin: '2004', name: 'Valentina Katić', role: 'dispatcher' },
            { id: 10, pin: '3001', name: 'Marija Subašić', role: 'admin' },
            { id: 11, pin: '3002', name: 'Marko Mišić', role: 'admin' },
            { id: 12, pin: '3003', name: 'Nataša Mišić', role: 'admin' },
            { id: 13, pin: '3004', name: 'Ana Plećević', role: 'admin' },
        ];

        const DENOMINATIONS_RSD = [
            { value: 5000, label: '5.000' },
            { value: 2000, label: '2.000' },
            { value: 1000, label: '1.000' },
            { value: 500, label: '500' },
            { value: 200, label: '200' },
            { value: 100, label: '100' },
            { value: 50, label: '50' },
            { value: 20, label: '20' },
            { value: 10, label: '10' },
        ];

        const DENOMINATIONS_EUR = [
            { value: 500, label: '500' },
            { value: 200, label: '200' },
            { value: 100, label: '100' },
            { value: 50, label: '50' },
            { value: 20, label: '20' },
            { value: 10, label: '10' },
            { value: 5, label: '5' },
        ];

        const TRANSACTION_TYPES = {
            DRIVER_DEPOSIT: 'Predaja vozača',
            CASH_REGISTER: 'Podignuto sa blagajne',
            OTHER_DEPOSIT: 'Drugi unos',
            WITHDRAWAL: 'Izuzimanje',
            SURPLUS: 'Višak - kontrola',
            SHORTAGE: 'Manjak - kontrola',
        };

        const DEFAULT_SHIFTS = [];
        const DEFAULT_SUBMISSIONS = [];
        const DEFAULT_SAFE_TRANSACTIONS = [];
        const DEFAULT_SAFE_CONTROLS = [];

        const formatCurrency = (n, currency = 'RSD') => new Intl.NumberFormat('sr-RS').format(n || 0) + ' ' + currency;
        const formatNumber = (n) => new Intl.NumberFormat('sr-RS').format(n || 0);
        const formatDate = (date) => new Date(date).toLocaleDateString('sr-RS');
        const formatDateTime = (date) => new Date(date).toLocaleString('sr-RS');

        // ============ KOMPONENTE ============
        const Notification = ({ message, type, onClose }) => (
            <div className={`fixed top-4 right-4 left-4 z-50 p-4 rounded-lg border-2 shadow-lg flex items-center gap-3 ${type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : type === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-blue-50 border-blue-200 text-blue-800'}`}>
                <Icon name="bell" /><span className="font-medium flex-1">{message}</span><button onClick={onClose}><Icon name="x" /></button>
            </div>
        );

        const Header = ({ user, onLogout, title, onBack, onRefresh }) => {
            const role = ROLES.find(r => r.id === user?.role);
            return (
                <div className="bg-white border-b sticky top-0 z-40">
                    <div className="max-w-lg mx-auto px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            {onBack && <button onClick={onBack} className="p-2 -ml-2 text-gray-400"><Icon name="arrowLeft" /></button>}
                            <div><h1 className="font-bold text-gray-800">{title}</h1><p className="text-sm text-gray-500">{user?.name}{role && ` • ${role.name}`}</p></div>
                        </div>
                        <div className="flex items-center gap-2">
                            {onRefresh && <button onClick={onRefresh} className="p-2 text-gray-400 hover:text-blue-500"><Icon name="refresh" /></button>}
                            <button onClick={onLogout} className="p-2 text-gray-400 hover:text-red-500"><Icon name="logout" /></button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============ LOGIN ============
        const LoginScreen = ({ onLogin, users }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); const u = users.find(x => x.pin === pin); if (u) onLogin(u); else { setError('Pogrešna šifra'); setPin(''); } };
            return (
                <div className="min-h-screen bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600"><Icon name="truck" size={40} /></div>
                            <h1 className="text-2xl font-bold text-gray-800">Dostava</h1>
                            <p className="text-gray-500 mt-1">Predaja Pazara</p>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="flex justify-center gap-3 mb-6">
                                {[0,1,2,3].map(i => <div key={i} className={`w-14 h-14 rounded-xl border-2 flex items-center justify-center text-2xl font-bold ${pin.length > i ? 'border-orange-500 bg-orange-50' : 'border-gray-200'}`}>{pin.length > i ? '•' : ''}</div>)}
                            </div>
                            {error && <div className="text-red-500 text-center mb-4">{error}</div>}
                            <div className="grid grid-cols-3 gap-3 mb-6">
                                {[1,2,3,4,5,6,7,8,9,null,0,'del'].map((n,i) => <button key={i} type="button" onClick={() => n === 'del' ? setPin(p => p.slice(0,-1)) : n !== null && pin.length < 4 && setPin(p => p + n)} disabled={n === null} className={`h-14 rounded-xl text-xl font-semibold ${n === null ? 'invisible' : n === 'del' ? 'bg-gray-100' : 'bg-gray-50 active:scale-95'}`}>{n === 'del' ? '⌫' : n}</button>)}
                            </div>
                            <button type="submit" disabled={pin.length !== 4} className="w-full py-4 bg-orange-500 text-white rounded-xl font-semibold disabled:bg-gray-300">Prijava</button>
                        </form>
                    </div>
                </div>
            );
        };

        // ============ SPECIFIKACIJA APOENA ============
        const DenominationInput = ({ apoeni, setApoeni, currency = 'RSD', readOnly = false }) => {
            const denominations = currency === 'EUR' ? DENOMINATIONS_EUR : DENOMINATIONS_RSD;
            const total = denominations.reduce((sum, d) => sum + (d.value * (apoeni[d.value] || 0)), 0);
            return (
                <div className="space-y-2">
                    <p className="font-semibold text-gray-700">Specifikacija novčanica ({currency}):</p>
                    {denominations.map(d => (
                        <div key={d.value} className="flex items-center gap-2 bg-white rounded-lg p-2 border">
                            <span className="w-14 font-semibold text-gray-700 text-sm">{d.label}</span>
                            <span className="text-gray-400">×</span>
                            {readOnly ? (
                                <span className="flex-1 text-center font-bold">{apoeni[d.value] || 0}</span>
                            ) : (
                                <input type="number" min="0" value={apoeni[d.value] || ''} onChange={(e) => setApoeni({...apoeni, [d.value]: parseInt(e.target.value) || 0})} placeholder="0" className="flex-1 p-2 text-center font-semibold border rounded" />
                            )}
                            <span className="w-20 text-right text-sm text-gray-600">{formatNumber(d.value * (apoeni[d.value] || 0))}</span>
                        </div>
                    ))}
                    <div className="flex justify-between items-center bg-green-100 rounded-lg p-3 mt-3">
                        <span className="font-bold text-green-800">UKUPNO:</span>
                        <span className="font-bold text-xl text-green-800">{formatCurrency(total, currency)}</span>
                    </div>
                </div>
            );
        };

        // ============ VOZAČ HOME ============
        const DriverHome = ({ user, shifts, setShifts, submissions, setSubmissions, notify }) => {
            const [view, setView] = useState('home');
            const [apoeni, setApoeni] = useState({});
            const [dostave, setDostave] = useState('');
            const [mesto, setMesto] = useState('');

            const myShift = shifts.find(s => s.driverId === user.id && s.status === 'active');
            const hasZaduzenje = myShift?.zaduzenje > 0;
            const gotovina = DENOMINATIONS_RSD.reduce((sum, d) => sum + (d.value * (apoeni[d.value] || 0)), 0);

            const startShift = () => {
                const newShift = { id: Date.now(), driverId: user.id, startTime: new Date().toLocaleTimeString('sr-RS', {hour:'2-digit', minute:'2-digit'}), date: new Date().toLocaleDateString('sr-RS'), status: 'active', zaduzenje: null };
                const newShifts = [...shifts, newShift];
                setShifts(newShifts);
                saveToStorage(STORAGE_KEYS.SHIFTS, newShifts);
                notify('Smena započeta!');
            };

            const submitPazar = () => {
                if (!dostave || !mesto || gotovina === 0) return;
                const newSubmission = {
                    id: Date.now(),
                    driverId: user.id,
                    driverName: user.name,
                    date: myShift.date,
                    zaduzenje: myShift.zaduzenje,
                    dostave: parseInt(dostave),
                    mesto,
                    gotovina,
                    apoeni,
                    status: 'pending',
                    startTime: myShift.startTime,
                    endTime: new Date().toLocaleTimeString('sr-RS', {hour:'2-digit', minute:'2-digit'}),
                    createdAt: new Date().toISOString()
                };
                const newSubmissions = [...submissions, newSubmission];
                setSubmissions(newSubmissions);
                saveToStorage(STORAGE_KEYS.SUBMISSIONS, newSubmissions);
                
                const newShifts = shifts.filter(s => s.id !== myShift.id);
                setShifts(newShifts);
                saveToStorage(STORAGE_KEYS.SHIFTS, newShifts);
                
                setView('home');
                setApoeni({});
                setDostave('');
                setMesto('');
                notify('Pazar predat!');
            };

            if (view === 'razduzenje') {
                return (
                    <div className="p-4 space-y-4">
                        <div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
                            <p className="text-sm text-orange-600">E-Bar predaja gotovina</p>
                            <p className="text-3xl font-bold text-orange-700">{formatCurrency(myShift.zaduzenje)}</p>
                        </div>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600">Broj dostava</label>
                            <input type="number" value={dostave} onChange={(e) => setDostave(e.target.value)} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl mt-2" />
                        </div>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600 mb-3 block">Mesto predaje</label>
                            <div className="grid grid-cols-2 gap-2">
                                {DELIVERY_LOCATIONS.map(loc => (
                                    <button key={loc.id} onClick={() => setMesto(loc.id)} className={`p-3 rounded-xl border-2 text-sm font-medium ${mesto === loc.id ? 'border-orange-500 bg-orange-50 text-orange-700' : 'border-gray-200'}`}>
                                        {loc.name}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                            <DenominationInput apoeni={apoeni} setApoeni={setApoeni} currency="RSD" />
                        </div>

                        {gotovina !== myShift.zaduzenje && gotovina > 0 && (
                            <div className={`rounded-xl p-4 ${gotovina > myShift.zaduzenje ? 'bg-blue-100 border-2 border-blue-300' : 'bg-red-100 border-2 border-red-300'}`}>
                                <div className="flex justify-between">
                                    <span>Razlika:</span>
                                    <span className={`font-bold ${gotovina > myShift.zaduzenje ? 'text-blue-700' : 'text-red-700'}`}>
                                        {gotovina > myShift.zaduzenje ? '+' : ''}{formatCurrency(gotovina - myShift.zaduzenje)}
                                    </span>
                                </div>
                            </div>
                        )}

                        <div className="flex gap-3">
                            <button onClick={() => setView('home')} className="flex-1 py-4 border-2 rounded-xl font-semibold">Otkaži</button>
                            <button onClick={submitPazar} disabled={!dostave || !mesto || gotovina === 0} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-semibold disabled:bg-gray-300">✓ Predaj pazar</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-4 space-y-4">
                    {!myShift ? (
                        <>
                            <div className="bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl p-6">
                                <h2 className="text-2xl font-bold text-gray-700">Nema aktivne smene</h2>
                                <p className="text-gray-500">Započnite smenu za danas</p>
                            </div>
                            <button onClick={startShift} className="w-full bg-green-500 text-white rounded-2xl p-6 flex items-center justify-between">
                                <div className="flex items-center gap-4"><div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center"><Icon name="clock" /></div><div className="text-left"><p className="font-bold text-lg">Započni smenu</p></div></div><Icon name="chevronRight" />
                            </button>
                        </>
                    ) : (
                        <>
                            <div className="bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl p-6 text-white">
                                <div className="flex items-center gap-2 mb-2"><Icon name="clock" size={18} /><span className="opacity-80">Smena od {myShift.startTime}</span></div>
                                <h2 className="text-2xl font-bold">Smena aktivna</h2>
                                <p className="opacity-80">{myShift.date}</p>
                            </div>

                            {!hasZaduzenje ? (
                                <div className="bg-yellow-50 rounded-xl p-6 border-2 border-yellow-200">
                                    <div className="flex items-center gap-3 text-yellow-700">
                                        <Icon name="clock" />
                                        <div>
                                            <p className="font-bold">Čekate zaduženje</p>
                                            <p className="text-sm">Dispecer će vam upisati E-Bar zaduženje</p>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                                        <p className="text-sm text-green-600">E-Bar predaja gotovina</p>
                                        <p className="text-3xl font-bold text-green-700">{formatCurrency(myShift.zaduzenje)}</p>
                                    </div>
                                    <button onClick={() => setView('razduzenje')} className="w-full bg-orange-500 text-white rounded-2xl p-6 flex items-center justify-between">
                                        <div className="flex items-center gap-4"><div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center"><Icon name="banknote" /></div><div className="text-left"><p className="font-bold text-lg">Razduži se</p><p className="text-sm opacity-80">Predaj pazar</p></div></div><Icon name="chevronRight" />
                                    </button>
                                </>
                            )}
                        </>
                    )}
                </div>
            );
        };

        // ============ DISPECER HOME ============
        const DispatcherHome = ({ users, shifts, setShifts, notify }) => {
            const [selectedDriver, setSelectedDriver] = useState(null);
            const [zaduzenje, setZaduzenje] = useState('');

            const drivers = users.filter(u => u.role === 'driver');
            const activeShifts = shifts.filter(s => s.status === 'active');

            const saveZaduzenje = () => {
                if (!zaduzenje) return;
                const newShifts = shifts.map(s => s.driverId === selectedDriver.id && s.status === 'active' ? {...s, zaduzenje: parseInt(zaduzenje)} : s);
                setShifts(newShifts);
                saveToStorage(STORAGE_KEYS.SHIFTS, newShifts);
                setSelectedDriver(null);
                setZaduzenje('');
                notify('Zaduženje upisano!');
            };

            if (selectedDriver) {
                const shift = activeShifts.find(s => s.driverId === selectedDriver.id);
                return (
                    <div className="p-4 space-y-4">
                        <div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
                            <p className="font-bold text-orange-800">{selectedDriver.name}</p>
                            <p className="text-sm text-orange-600">Na smeni od {shift?.startTime}</p>
                        </div>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600">E-Bar predaja gotovina</label>
                            <input type="number" value={zaduzenje} onChange={(e) => setZaduzenje(e.target.value)} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl mt-2" />
                        </div>

                        <div className="flex gap-3">
                            <button onClick={() => { setSelectedDriver(null); setZaduzenje(''); }} className="flex-1 py-4 border-2 rounded-xl font-semibold">Otkaži</button>
                            <button onClick={saveZaduzenje} disabled={!zaduzenje} className="flex-1 py-4 bg-orange-500 text-white rounded-xl font-semibold disabled:bg-gray-300">Sačuvaj</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-4 space-y-4">
                    <div className="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl p-6 text-white">
                        <p className="opacity-80">Vozači na smeni</p>
                        <p className="text-3xl font-bold">{activeShifts.length}</p>
                    </div>

                    <p className="font-bold text-gray-700">Vozači na smeni:</p>

                    {activeShifts.length === 0 ? (
                        <div className="bg-gray-50 rounded-xl p-6 text-center text-gray-500">Nema vozača na smeni</div>
                    ) : (
                        activeShifts.map(shift => {
                            const driver = drivers.find(d => d.id === shift.driverId);
                            return (
                                <div key={shift.id} className="bg-white rounded-xl p-4 border-2">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <p className="font-semibold">{driver?.name}</p>
                                            <p className="text-sm text-gray-500">Od {shift.startTime}</p>
                                        </div>
                                        <div className="text-right">
                                            {shift.zaduzenje ? (
                                                <div>
                                                    <p className="font-bold text-green-600">{formatCurrency(shift.zaduzenje)}</p>
                                                    <button onClick={() => { setSelectedDriver(driver); setZaduzenje(shift.zaduzenje.toString()); }} className="text-xs text-blue-500">Izmeni</button>
                                                </div>
                                            ) : (
                                                <button onClick={() => setSelectedDriver(driver)} className="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-semibold">Upiši zaduženje</button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })
                    )}
                </div>
            );
        };

        // ============ GRAFIKON ============
        const SalesChart = ({ data, type = 'bar', title }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) chartRef.current.destroy();
                if (!data.labels?.length) return;
                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: type,
                    data: data,
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10 } } },
                        scales: type !== 'pie' && type !== 'doughnut' ? { y: { beginAtZero: true, ticks: { callback: (v) => formatNumber(v) } } } : undefined
                    }
                });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type]);

            return (
                <div className="bg-white rounded-xl p-4 border-2">
                    {title && <p className="font-bold text-gray-800 mb-3">{title}</p>}
                    <div style={{ height: '200px' }}><canvas ref={canvasRef}></canvas></div>
                </div>
            );
        };

        // ============ ADMIN HOME ============
        const AdminHome = ({ users, setUsers, submissions, setSubmissions, safeTransactions, setSafeTransactions, safeControls, setSafeControls, notify, currentUser }) => {
            const [view, setView] = useState('home');
            const [verifying, setVerifying] = useState(null);
            const [adminApoeni, setAdminApoeni] = useState({});

            // Safe transaction form
            const [txType, setTxType] = useState('deposit');
            const [txAmount, setTxAmount] = useState('');
            const [txCurrency, setTxCurrency] = useState('RSD');
            const [txSource, setTxSource] = useState('CASH_REGISTER');
            const [txDescription, setTxDescription] = useState('');

            // Safe control form
            const [controlCurrency, setControlCurrency] = useState('RSD');
            const [controlApoeni, setControlApoeni] = useState({});
            const [controlReason, setControlReason] = useState('');

            // Reports filter
            const [reportDateFrom, setReportDateFrom] = useState('');
            const [reportDateTo, setReportDateTo] = useState('');

            const pending = submissions.filter(s => s.status === 'pending');
            const verified = submissions.filter(s => s.status === 'verified');
            const drivers = users.filter(u => u.role === 'driver');

            // Izračunaj stanje sefa
            const calculateSafeBalance = (currency) => {
                return safeTransactions
                    .filter(t => t.currency === currency)
                    .reduce((sum, t) => sum + (t.type === 'in' ? t.amount : -t.amount), 0);
            };

            const safeBalanceRSD = calculateSafeBalance('RSD');
            const safeBalanceEUR = calculateSafeBalance('EUR');

            const handleVerify = (id) => {
                const adminGotovina = DENOMINATIONS_RSD.reduce((sum, d) => sum + (d.value * (adminApoeni[d.value] || 0)), 0);
                const sub = submissions.find(s => s.id === id);
                
                // Update submission
                const newSubmissions = submissions.map(s => s.id === id ? {...s, status: 'verified', adminGotovina, adminApoeni: {...adminApoeni}, verifiedBy: currentUser.name, verifiedAt: new Date().toISOString()} : s);
                setSubmissions(newSubmissions);
                saveToStorage(STORAGE_KEYS.SUBMISSIONS, newSubmissions);

                // Add to safe transactions
                const newTx = {
                    id: Date.now(),
                    type: 'in',
                    amount: adminGotovina,
                    currency: 'RSD',
                    source: 'DRIVER_DEPOSIT',
                    description: `Predaja vozača: ${sub.driverName}`,
                    createdBy: currentUser.name,
                    createdAt: new Date().toISOString(),
                    relatedSubmissionId: id
                };
                const newTransactions = [...safeTransactions, newTx];
                setSafeTransactions(newTransactions);
                saveToStorage(STORAGE_KEYS.SAFE_TRANSACTIONS, newTransactions);

                setVerifying(null);
                setAdminApoeni({});
                notify('Potvrđeno u Interni sef!');
            };

            const handleSafeTransaction = () => {
                if (!txAmount) return;
                const amount = parseFloat(txAmount);
                const newTx = {
                    id: Date.now(),
                    type: txType === 'deposit' ? 'in' : 'out',
                    amount,
                    currency: txCurrency,
                    source: txType === 'deposit' ? txSource : 'WITHDRAWAL',
                    description: txDescription || (txType === 'deposit' ? TRANSACTION_TYPES[txSource] : 'Izuzimanje iz sefa'),
                    createdBy: currentUser.name,
                    createdAt: new Date().toISOString()
                };
                const newTransactions = [...safeTransactions, newTx];
                setSafeTransactions(newTransactions);
                saveToStorage(STORAGE_KEYS.SAFE_TRANSACTIONS, newTransactions);

                setTxAmount('');
                setTxDescription('');
                setView('home');
                notify(txType === 'deposit' ? 'Novac dodat u sef!' : 'Novac izuzet iz sefa!');
            };

            const handleSafeControl = () => {
                const denominations = controlCurrency === 'EUR' ? DENOMINATIONS_EUR : DENOMINATIONS_RSD;
                const counted = denominations.reduce((sum, d) => sum + (d.value * (controlApoeni[d.value] || 0)), 0);
                const expected = calculateSafeBalance(controlCurrency);
                const difference = counted - expected;

                const newControl = {
                    id: Date.now(),
                    currency: controlCurrency,
                    expected,
                    counted,
                    difference,
                    apoeni: {...controlApoeni},
                    reason: controlReason,
                    createdBy: currentUser.name,
                    createdAt: new Date().toISOString()
                };
                const newControls = [...safeControls, newControl];
                setSafeControls(newControls);
                saveToStorage(STORAGE_KEYS.SAFE_CONTROLS, newControls);

                // Ako ima razlike, dodaj transakciju za sravnjenje
                if (difference !== 0) {
                    const newTx = {
                        id: Date.now() + 1,
                        type: difference > 0 ? 'in' : 'out',
                        amount: Math.abs(difference),
                        currency: controlCurrency,
                        source: difference > 0 ? 'SURPLUS' : 'SHORTAGE',
                        description: `${difference > 0 ? 'Višak' : 'Manjak'} - kontrola sefa: ${controlReason}`,
                        createdBy: currentUser.name,
                        createdAt: new Date().toISOString(),
                        relatedControlId: newControl.id
                    };
                    const newTransactions = [...safeTransactions, newTx];
                    setSafeTransactions(newTransactions);
                    saveToStorage(STORAGE_KEYS.SAFE_TRANSACTIONS, newTransactions);
                }

                setControlApoeni({});
                setControlReason('');
                setView('home');
                notify(difference === 0 ? 'Kontrola uspešna - stanje tačno!' : `Sravnjenje izvršeno (${difference > 0 ? 'višak' : 'manjak'}: ${formatCurrency(Math.abs(difference), controlCurrency)})`);
            };

            // Statistike po vozačima
            const driverStats = drivers.map(driver => {
                const driverSubs = verified.filter(s => s.driverId === driver.id);
                return {
                    ...driver,
                    totalGotovina: driverSubs.reduce((sum, s) => sum + (s.adminGotovina || s.gotovina), 0),
                    totalDostave: driverSubs.reduce((sum, s) => sum + s.dostave, 0),
                    count: driverSubs.length
                };
            }).sort((a, b) => b.totalGotovina - a.totalGotovina);

            // Filter transactions for reports
            const filteredTransactions = safeTransactions.filter(t => {
                if (!reportDateFrom && !reportDateTo) return true;
                const txDate = new Date(t.createdAt);
                if (reportDateFrom && txDate < new Date(reportDateFrom)) return false;
                if (reportDateTo && txDate > new Date(reportDateTo + 'T23:59:59')) return false;
                return true;
            });

            // VERIFY VIEW
            if (verifying) {
                const driver = drivers.find(d => d.id === verifying.driverId);
                const adminGotovina = DENOMINATIONS_RSD.reduce((sum, d) => sum + (d.value * (adminApoeni[d.value] || 0)), 0);
                const diff = adminGotovina - verifying.gotovina;

                return (
                    <div className="p-4 space-y-4">
                        <div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
                            <p className="font-bold text-orange-800">{driver?.name}</p>
                            <p className="text-sm text-orange-600">{verifying.date} • {verifying.startTime} - {verifying.endTime}</p>
                        </div>

                        <div className="bg-gray-50 rounded-xl p-4">
                            <p className="font-semibold mb-2">Vozač prijavio:</p>
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                <div className="bg-white rounded p-2"><span className="text-gray-500">Zaduženje:</span> <span className="font-bold">{formatNumber(verifying.zaduzenje)}</span></div>
                                <div className="bg-white rounded p-2"><span className="text-gray-500">Dostave:</span> <span className="font-bold">{verifying.dostave}</span></div>
                                <div className="bg-green-50 rounded p-2 col-span-2"><span className="text-green-600">Gotovina:</span> <span className="font-bold">{formatNumber(verifying.gotovina)}</span></div>
                            </div>
                        </div>

                        <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                            <DenominationInput apoeni={adminApoeni} setApoeni={setAdminApoeni} currency="RSD" />
                        </div>

                        {adminGotovina > 0 && diff !== 0 && (
                            <div className={`rounded-xl p-4 ${diff > 0 ? 'bg-blue-100' : 'bg-red-100'}`}>
                                <div className="flex justify-between"><span>Razlika:</span><span className="font-bold">{diff > 0 ? '+' : ''}{formatCurrency(diff)}</span></div>
                            </div>
                        )}

                        <div className="flex gap-3">
                            <button onClick={() => { setVerifying(null); setAdminApoeni({}); }} className="flex-1 py-4 border-2 rounded-xl font-semibold">Otkaži</button>
                            <button onClick={() => handleVerify(verifying.id)} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-semibold">✓ U Interni sef</button>
                        </div>
                    </div>
                );
            }

            // ADD MONEY VIEW
            if (view === 'addMoney') {
                return (
                    <div className="p-4 space-y-4">
                        <button onClick={() => setView('home')} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button>
                        <h2 className="text-xl font-bold">Dodaj novac u sef</h2>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600 mb-2 block">Izvor novca</label>
                            <div className="space-y-2">
                                <button onClick={() => setTxSource('CASH_REGISTER')} className={`w-full p-3 rounded-xl border-2 text-left ${txSource === 'CASH_REGISTER' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>
                                    Podignuto sa blagajne
                                </button>
                                <button onClick={() => setTxSource('OTHER_DEPOSIT')} className={`w-full p-3 rounded-xl border-2 text-left ${txSource === 'OTHER_DEPOSIT' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>
                                    Drugo
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600 mb-2 block">Valuta</label>
                            <div className="flex gap-2">
                                <button onClick={() => setTxCurrency('RSD')} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${txCurrency === 'RSD' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>RSD</button>
                                <button onClick={() => setTxCurrency('EUR')} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${txCurrency === 'EUR' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>EUR</button>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600">Iznos ({txCurrency})</label>
                            <input type="number" value={txAmount} onChange={(e) => setTxAmount(e.target.value)} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl mt-2" />
                        </div>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600">Opis (opciono)</label>
                            <input type="text" value={txDescription} onChange={(e) => setTxDescription(e.target.value)} placeholder="npr. Kusur za lokal" className="w-full p-3 border-2 rounded-xl mt-2" />
                        </div>

                        <button onClick={() => { setTxType('deposit'); handleSafeTransaction(); }} disabled={!txAmount} className="w-full py-4 bg-green-500 text-white rounded-xl font-semibold disabled:bg-gray-300">
                            ✓ Dodaj u sef
                        </button>
                    </div>
                );
            }

            // WITHDRAW MONEY VIEW
            if (view === 'withdrawMoney') {
                return (
                    <div className="p-4 space-y-4">
                        <button onClick={() => setView('home')} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button>
                        <h2 className="text-xl font-bold">Uzmi novac iz sefa</h2>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600 mb-2 block">Valuta</label>
                            <div className="flex gap-2">
                                <button onClick={() => setTxCurrency('RSD')} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${txCurrency === 'RSD' ? 'border-red-500 bg-red-50' : 'border-gray-200'}`}>RSD ({formatNumber(safeBalanceRSD)})</button>
                                <button onClick={() => setTxCurrency('EUR')} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${txCurrency === 'EUR' ? 'border-red-500 bg-red-50' : 'border-gray-200'}`}>EUR ({formatNumber(safeBalanceEUR)})</button>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600">Iznos ({txCurrency})</label>
                            <input type="number" value={txAmount} onChange={(e) => setTxAmount(e.target.value)} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl mt-2" />
                        </div>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600">Razlog (obavezno)</label>
                            <input type="text" value={txDescription} onChange={(e) => setTxDescription(e.target.value)} placeholder="npr. Kusur za P-47, Plaćanje dobavljaču" className="w-full p-3 border-2 rounded-xl mt-2" />
                        </div>

                        <button onClick={() => { setTxType('withdraw'); handleSafeTransaction(); }} disabled={!txAmount || !txDescription} className="w-full py-4 bg-red-500 text-white rounded-xl font-semibold disabled:bg-gray-300">
                            Uzmi iz sefa
                        </button>
                    </div>
                );
            }

            // SAFE CONTROL VIEW
            if (view === 'safeControl') {
                const denominations = controlCurrency === 'EUR' ? DENOMINATIONS_EUR : DENOMINATIONS_RSD;
                const counted = denominations.reduce((sum, d) => sum + (d.value * (controlApoeni[d.value] || 0)), 0);
                const expected = calculateSafeBalance(controlCurrency);
                const difference = counted - expected;

                return (
                    <div className="p-4 space-y-4">
                        <button onClick={() => { setView('home'); setControlApoeni({}); }} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button>
                        <h2 className="text-xl font-bold">Kontrola sefa</h2>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <label className="text-sm font-medium text-gray-600 mb-2 block">Valuta</label>
                            <div className="flex gap-2">
                                <button onClick={() => { setControlCurrency('RSD'); setControlApoeni({}); }} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${controlCurrency === 'RSD' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}`}>RSD</button>
                                <button onClick={() => { setControlCurrency('EUR'); setControlApoeni({}); }} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${controlCurrency === 'EUR' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}`}>EUR</button>
                            </div>
                        </div>

                        <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                            <p className="text-sm text-blue-600">Stanje u sistemu</p>
                            <p className="text-2xl font-bold text-blue-700">{formatCurrency(expected, controlCurrency)}</p>
                        </div>

                        <div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
                            <DenominationInput apoeni={controlApoeni} setApoeni={setControlApoeni} currency={controlCurrency} />
                        </div>

                        {counted > 0 && (
                            <div className={`rounded-xl p-4 ${difference === 0 ? 'bg-green-100 border-2 border-green-300' : difference > 0 ? 'bg-blue-100 border-2 border-blue-300' : 'bg-red-100 border-2 border-red-300'}`}>
                                <div className="flex justify-between items-center">
                                    <span className="font-semibold">Razlika:</span>
                                    <span className={`font-bold text-xl ${difference === 0 ? 'text-green-700' : difference > 0 ? 'text-blue-700' : 'text-red-700'}`}>
                                        {difference === 0 ? '✓ Tačno' : (difference > 0 ? '+' : '') + formatCurrency(difference, controlCurrency)}
                                    </span>
                                </div>
                            </div>
                        )}

                        {counted > 0 && difference !== 0 && (
                            <div className="bg-white rounded-xl p-4 border-2">
                                <label className="text-sm font-medium text-gray-600">Razlog {difference > 0 ? 'viška' : 'manjka'}</label>
                                <input type="text" value={controlReason} onChange={(e) => setControlReason(e.target.value)} placeholder="Unesite razlog..." className="w-full p-3 border-2 rounded-xl mt-2" />
                            </div>
                        )}

                        <button onClick={handleSafeControl} disabled={counted === 0 || (difference !== 0 && !controlReason)} className="w-full py-4 bg-purple-500 text-white rounded-xl font-semibold disabled:bg-gray-300">
                            {difference === 0 ? '✓ Potvrdi kontrolu' : '✓ Izvrši sravnjenje'}
                        </button>
                    </div>
                );
            }

            // REPORTS VIEW
            if (view === 'reports') {
                const totalIn = filteredTransactions.filter(t => t.type === 'in' && t.currency === 'RSD').reduce((sum, t) => sum + t.amount, 0);
                const totalOut = filteredTransactions.filter(t => t.type === 'out' && t.currency === 'RSD').reduce((sum, t) => sum + t.amount, 0);

                return (
                    <div className="p-4 space-y-4">
                        <button onClick={() => setView('home')} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button>
                        <h2 className="text-xl font-bold">Izveštaji</h2>

                        <div className="bg-white rounded-xl p-4 border-2">
                            <p className="text-sm font-medium text-gray-600 mb-2">Period</p>
                            <div className="flex gap-2">
                                <input type="date" value={reportDateFrom} onChange={(e) => setReportDateFrom(e.target.value)} className="flex-1 p-2 border rounded-lg" />
                                <input type="date" value={reportDateTo} onChange={(e) => setReportDateTo(e.target.value)} className="flex-1 p-2 border rounded-lg" />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                                <p className="text-sm text-green-600">Ulaz</p>
                                <p className="text-xl font-bold text-green-700">{formatCurrency(totalIn)}</p>
                            </div>
                            <div className="bg-red-50 rounded-xl p-4 border-2 border-red-200">
                                <p className="text-sm text-red-600">Izlaz</p>
                                <p className="text-xl font-bold text-red-700">{formatCurrency(totalOut)}</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl border-2 overflow-hidden">
                            <div className="bg-gray-50 p-3 border-b font-bold">Transakcije ({filteredTransactions.length})</div>
                            <div className="max-h-96 overflow-y-auto">
                                {filteredTransactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(tx => (
                                    <div key={tx.id} className="p-3 border-b last:border-b-0 flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${tx.type === 'in' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                                <Icon name={tx.type === 'in' ? 'arrowDown' : 'arrowUp'} size={16} />
                                            </div>
                                            <div>
                                                <p className="font-medium text-sm">{tx.description}</p>
                                                <p className="text-xs text-gray-500">{formatDateTime(tx.createdAt)} • {tx.createdBy}</p>
                                            </div>
                                        </div>
                                        <p className={`font-bold ${tx.type === 'in' ? 'text-green-600' : 'text-red-600'}`}>
                                            {tx.type === 'in' ? '+' : '-'}{formatCurrency(tx.amount, tx.currency)}
                                        </p>
                                    </div>
                                ))}
                                {filteredTransactions.length === 0 && (
                                    <p className="p-4 text-center text-gray-500">Nema transakcija</p>
                                )}
                            </div>
                        </div>

                        {safeControls.length > 0 && (
                            <div className="bg-white rounded-xl border-2 overflow-hidden">
                                <div className="bg-purple-50 p-3 border-b font-bold">Kontrole sefa</div>
                                {safeControls.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5).map(ctrl => (
                                    <div key={ctrl.id} className="p-3 border-b last:border-b-0">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <p className="font-medium">{ctrl.currency}</p>
                                                <p className="text-xs text-gray-500">{formatDateTime(ctrl.createdAt)} • {ctrl.createdBy}</p>
                                            </div>
                                            <div className={`font-bold ${ctrl.difference === 0 ? 'text-green-600' : ctrl.difference > 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                                {ctrl.difference === 0 ? '✓ OK' : (ctrl.difference > 0 ? '+' : '') + formatCurrency(ctrl.difference, ctrl.currency)}
                                            </div>
                                        </div>
                                        {ctrl.reason && <p className="text-xs text-gray-500 mt-1">Razlog: {ctrl.reason}</p>}
                                    </div>
                                ))}
                            </div>
                        )}

                        {driverStats.some(d => d.totalGotovina > 0) && (
                            <div className="bg-white rounded-xl border-2 overflow-hidden">
                                <div className="bg-orange-50 p-3 border-b font-bold">Po vozačima</div>
                                {driverStats.filter(d => d.totalGotovina > 0).map(driver => (
                                    <div key={driver.id} className="p-3 border-b last:border-b-0 flex justify-between items-center">
                                        <div>
                                            <p className="font-semibold">{driver.name}</p>
                                            <p className="text-xs text-gray-500">{driver.totalDostave} dostava • {driver.count} smena</p>
                                        </div>
                                        <p className="font-bold text-green-600">{formatNumber(driver.totalGotovina)}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            }

            // USERS VIEW
            if (view === 'users') {
                return (
                    <div className="p-4 space-y-4">
                        <button onClick={() => setView('home')} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button>
                        <h2 className="text-xl font-bold">Korisnici</h2>
                        {users.map(u => {
                            const r = ROLES.find(x => x.id === u.role);
                            return (
                                <div key={u.id} className="bg-white rounded-xl p-4 border-2 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center"><Icon name={r?.icon} size={20} /></div>
                                        <div><p className="font-semibold">{u.name}</p><p className="text-sm text-gray-500">{r?.name}</p></div>
                                    </div>
                                    <span className="px-2 py-1 bg-gray-100 rounded font-mono text-sm">{u.pin}</span>
                                </div>
                            );
                        })}
                    </div>
                );
            }

            // HOME VIEW
            return (
                <div className="p-4 space-y-4">
                    {/* Stanje sefa */}
                    <div className="bg-gradient-to-r from-orange-500 to-red-600 rounded-2xl p-5 text-white">
                        <p className="text-sm opacity-80">INTERNI SEF</p>
                        <div className="flex justify-between items-end mt-2">
                            <div>
                                <p className="text-3xl font-bold">{formatCurrency(safeBalanceRSD)}</p>
                                {safeBalanceEUR > 0 && <p className="text-lg opacity-80">{formatCurrency(safeBalanceEUR, 'EUR')}</p>}
                            </div>
                        </div>
                    </div>

                    {/* Quick actions */}
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={() => setView('addMoney')} className="bg-green-500 text-white rounded-2xl p-4 flex flex-col items-center">
                            <Icon name="plus" /><p className="font-semibold mt-2 text-sm">Dodaj u sef</p>
                        </button>
                        <button onClick={() => setView('withdrawMoney')} className="bg-red-500 text-white rounded-2xl p-4 flex flex-col items-center">
                            <Icon name="minus" /><p className="font-semibold mt-2 text-sm">Uzmi iz sefa</p>
                        </button>
                        <button onClick={() => setView('safeControl')} className="bg-purple-500 text-white rounded-2xl p-4 flex flex-col items-center">
                            <Icon name="clipboardCheck" /><p className="font-semibold mt-2 text-sm">Kontrola sefa</p>
                        </button>
                        <button onClick={() => setView('reports')} className="bg-blue-500 text-white rounded-2xl p-4 flex flex-col items-center">
                            <Icon name="fileText" /><p className="font-semibold mt-2 text-sm">Izveštaji</p>
                        </button>
                    </div>

                    <button onClick={() => setView('users')} className="w-full bg-gray-100 rounded-xl p-4 flex items-center justify-between">
                        <div className="flex items-center gap-3"><Icon name="users" /><span className="font-semibold">Korisnici</span></div>
                        <Icon name="chevronRight" />
                    </button>

                    {/* Pending submissions */}
                    <div className="grid grid-cols-2 gap-2">
                        <div className="rounded-xl p-3 bg-orange-100 border-2 border-orange-300">
                            <p className="text-2xl font-bold text-orange-600">{pending.length}</p>
                            <p className="text-xs">Za proveru</p>
                        </div>
                        <div className="rounded-xl p-3 bg-green-100 border-2 border-green-300">
                            <p className="text-2xl font-bold text-green-600">{verified.length}</p>
                            <p className="text-xs">Potvrđeno</p>
                        </div>
                    </div>

                    {pending.length > 0 && <p className="font-bold text-gray-700">Za proveru:</p>}
                    {pending.map(sub => {
                        const driver = drivers.find(d => d.id === sub.driverId);
                        const mesto = DELIVERY_LOCATIONS.find(l => l.id === sub.mesto);
                        return (
                            <div key={sub.id} className="bg-white rounded-xl p-4 border-2 border-orange-200">
                                <div className="flex justify-between mb-3">
                                    <div>
                                        <p className="font-semibold">{driver?.name || sub.driverName}</p>
                                        <p className="text-sm text-gray-500">{sub.date} • {mesto?.name}</p>
                                    </div>
                                    <p className="font-bold text-lg text-green-700">{formatCurrency(sub.gotovina)}</p>
                                </div>
                                <div className="flex gap-2 text-xs mb-3">
                                    <span className="bg-gray-100 px-2 py-1 rounded">{sub.dostave} dostava</span>
                                    <span className="bg-gray-100 px-2 py-1 rounded">{sub.startTime} - {sub.endTime}</span>
                                </div>
                                <button onClick={() => { setVerifying(sub); setAdminApoeni(sub.apoeni || {}); }} className="w-full py-3 bg-orange-500 text-white rounded-lg font-semibold">Proveri</button>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // ============ MAIN APP ============
        function App() {
            const [users, setUsers] = useState(() => loadFromStorage(STORAGE_KEYS.USERS, DEFAULT_USERS));
            const [shifts, setShifts] = useState(() => loadFromStorage(STORAGE_KEYS.SHIFTS, DEFAULT_SHIFTS));
            const [submissions, setSubmissions] = useState(() => loadFromStorage(STORAGE_KEYS.SUBMISSIONS, DEFAULT_SUBMISSIONS));
            const [safeTransactions, setSafeTransactions] = useState(() => loadFromStorage(STORAGE_KEYS.SAFE_TRANSACTIONS, DEFAULT_SAFE_TRANSACTIONS));
            const [safeControls, setSafeControls] = useState(() => loadFromStorage(STORAGE_KEYS.SAFE_CONTROLS, DEFAULT_SAFE_CONTROLS));
            const [user, setUser] = useState(null);
            const [notif, setNotif] = useState(null);

            useEffect(() => {
                const handleStorage = (e) => {
                    if (e.key === STORAGE_KEYS.SHIFTS) setShifts(JSON.parse(e.newValue || '[]'));
                    if (e.key === STORAGE_KEYS.SUBMISSIONS) setSubmissions(JSON.parse(e.newValue || '[]'));
                    if (e.key === STORAGE_KEYS.USERS) setUsers(JSON.parse(e.newValue || '[]'));
                    if (e.key === STORAGE_KEYS.SAFE_TRANSACTIONS) setSafeTransactions(JSON.parse(e.newValue || '[]'));
                    if (e.key === STORAGE_KEYS.SAFE_CONTROLS) setSafeControls(JSON.parse(e.newValue || '[]'));
                };
                window.addEventListener('storage', handleStorage);
                return () => window.removeEventListener('storage', handleStorage);
            }, []);

            const notify = (msg, type='success') => { setNotif({msg, type}); setTimeout(() => setNotif(null), 3000); };

            const refreshData = () => {
                setShifts(loadFromStorage(STORAGE_KEYS.SHIFTS, DEFAULT_SHIFTS));
                setSubmissions(loadFromStorage(STORAGE_KEYS.SUBMISSIONS, DEFAULT_SUBMISSIONS));
                setSafeTransactions(loadFromStorage(STORAGE_KEYS.SAFE_TRANSACTIONS, DEFAULT_SAFE_TRANSACTIONS));
                setSafeControls(loadFromStorage(STORAGE_KEYS.SAFE_CONTROLS, DEFAULT_SAFE_CONTROLS));
                notify('Podaci osveženi!', 'info');
            };

            if (!user) return <LoginScreen onLogin={setUser} users={users} />;

            const titles = { driver: 'Vozač', dispatcher: 'Dispecer', admin: 'Administracija' };

            return (
                <div className="min-h-screen bg-gray-100">
                    {notif && <Notification message={notif.msg} type={notif.type} onClose={() => setNotif(null)} />}
                    <Header user={user} onLogout={() => setUser(null)} title={titles[user.role]} onRefresh={refreshData} />
                    <div className="max-w-lg mx-auto pb-8">
                        {user.role === 'driver' && <DriverHome user={user} shifts={shifts} setShifts={setShifts} submissions={submissions} setSubmissions={setSubmissions} notify={notify} />}
                        {user.role === 'dispatcher' && <DispatcherHome users={users} shifts={shifts} setShifts={setShifts} notify={notify} />}
                        {user.role === 'admin' && <AdminHome users={users} setUsers={setUsers} submissions={submissions} setSubmissions={setSubmissions} safeTransactions={safeTransactions} setSafeTransactions={setSafeTransactions} safeControls={safeControls} setSafeControls={setSafeControls} notify={notify} currentUser={user} />}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
