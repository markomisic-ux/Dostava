<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dostava - Predaja Pazara</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #f97316; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://oasjtgfphmngvnjcmpdb.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_jfBWjgDRxxo661HfgKRmxg_LJqrn438';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const Icon = ({name, size=24}) => {
            const icons = {
                truck: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 18H3V7h10v11M14 9h4l4 4v4h-2M7 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM17 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>,
                shield: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
                logout: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>,
                clock: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>,
                chevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18l6-6-6-6"/></svg>,
                arrowLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>,
                x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>,
                bell: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
                plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>,
                minus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/></svg>,
                banknote: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="12" cy="12" r="2"/></svg>,
                clipboardCheck: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>,
                arrowUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg>,
                arrowDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>,
                users: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
                userPlus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
                edit: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
                trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                fileText: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>,
                headphones: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg>,
                wifi: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"/></svg>,
            };
            return icons[name] || null;
        };

        const DELIVERY_LOCATIONS = [
            { id: 'KANCELARIJA', name: 'Kancelarija', short: 'KAN' },
            { id: 'MP-PAL', name: 'Palačinkarnica', short: 'PAL' },
            { id: 'MP-P47', name: 'Požeška 47', short: 'P-47' },
            { id: 'MP-P96', name: 'Požeška 96', short: 'P-96' },
            { id: 'MP-NBG', name: 'Novi Beograd', short: 'NBG' },
            { id: 'MP-DRA', name: 'Dravska', short: 'DRA' },
            { id: 'PRO-PEK', name: 'Pekara', short: 'PEK' },
            { id: 'FOOD-TRUCK', name: 'Food Truck', short: 'FT' },
        ];

        const ROLES = [
            { id: 'driver', name: 'Vozač', icon: 'truck' },
            { id: 'dispatcher', name: 'Dispecer', icon: 'headphones' },
            { id: 'admin', name: 'Admin', icon: 'shield' },
        ];

        const DENOMINATIONS_RSD = [
            { value: 5000, label: '5.000' }, { value: 2000, label: '2.000' }, { value: 1000, label: '1.000' },
            { value: 500, label: '500' }, { value: 200, label: '200' }, { value: 100, label: '100' },
            { value: 50, label: '50' }, { value: 20, label: '20' }, { value: 10, label: '10' },
        ];

        const DENOMINATIONS_EUR = [
            { value: 500, label: '500' }, { value: 200, label: '200' }, { value: 100, label: '100' },
            { value: 50, label: '50' }, { value: 20, label: '20' }, { value: 10, label: '10' }, { value: 5, label: '5' },
        ];

        const formatCurrency = (n, c = 'RSD') => new Intl.NumberFormat('sr-RS').format(n || 0) + ' ' + c;
        const formatNumber = (n) => new Intl.NumberFormat('sr-RS').format(n || 0);
        const formatDateTime = (d) => new Date(d).toLocaleString('sr-RS');

        const Notification = ({ message, type, onClose }) => (
            <div className={`fixed top-4 right-4 left-4 z-50 p-4 rounded-lg border-2 shadow-lg flex items-center gap-3 ${type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : type === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-blue-50 border-blue-200 text-blue-800'}`}>
                <Icon name="bell" /><span className="font-medium flex-1">{message}</span><button onClick={onClose}><Icon name="x" /></button>
            </div>
        );

        const LoadingSpinner = () => (<div className="flex items-center justify-center p-8"><div className="loader"></div></div>);

        const Header = ({ user, onLogout, title, online }) => {
            const role = ROLES.find(r => r.id === user?.role);
            return (
                <div className="bg-white border-b sticky top-0 z-40">
                    <div className="max-w-lg mx-auto px-4 py-3 flex items-center justify-between">
                        <div><div className="flex items-center gap-2"><h1 className="font-bold text-gray-800">{title}</h1><span className={`w-2 h-2 rounded-full ${online ? 'bg-green-500' : 'bg-red-500'}`}></span></div><p className="text-sm text-gray-500">{user?.name}{role && ` • ${role.name}`}</p></div>
                        <button onClick={onLogout} className="p-2 text-gray-400 hover:text-red-500"><Icon name="logout" /></button>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ title, message, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                    <h3 className="text-lg font-bold mb-2">{title}</h3>
                    <p className="text-gray-600 mb-6">{message}</p>
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-3 border-2 rounded-xl font-semibold">Otkaži</button>
                        <button onClick={onConfirm} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-semibold">Obriši</button>
                    </div>
                </div>
            </div>
        );

        const LoginScreen = ({ onLogin, loading }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');
            const [checking, setChecking] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setChecking(true); setError('');
                const { data, error: err } = await supabase.from('users').select('*').eq('pin', pin).single();
                if (err || !data) { setError('Pogrešna šifra'); setPin(''); }
                else onLogin(data);
                setChecking(false);
            };

            if (loading) return (<div className="min-h-screen bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center"><div className="bg-white rounded-3xl p-8"><LoadingSpinner /><p className="text-center text-gray-500 mt-4">Povezivanje...</p></div></div>);

            return (
                <div className="min-h-screen bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600"><Icon name="truck" size={40} /></div>
                            <h1 className="text-2xl font-bold text-gray-800">Dostava</h1>
                            <p className="text-gray-500 mt-1">Predaja Pazara</p>
                            <div className="flex items-center justify-center gap-2 mt-2 text-green-600 text-sm"><Icon name="wifi" size={16} /><span>Online</span></div>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="flex justify-center gap-3 mb-6">
                                {[0,1,2,3].map(i => <div key={i} className={`w-14 h-14 rounded-xl border-2 flex items-center justify-center text-2xl font-bold ${pin.length > i ? 'border-orange-500 bg-orange-50' : 'border-gray-200'}`}>{pin.length > i ? '•' : ''}</div>)}
                            </div>
                            {error && <div className="text-red-500 text-center mb-4">{error}</div>}
                            <div className="grid grid-cols-3 gap-3 mb-6">
                                {[1,2,3,4,5,6,7,8,9,null,0,'del'].map((n,i) => <button key={i} type="button" onClick={() => n === 'del' ? setPin(p => p.slice(0,-1)) : n !== null && pin.length < 4 && setPin(p => p + n)} disabled={n === null || checking} className={`h-14 rounded-xl text-xl font-semibold ${n === null ? 'invisible' : n === 'del' ? 'bg-gray-100' : 'bg-gray-50 active:scale-95'}`}>{n === 'del' ? '⌫' : n}</button>)}
                            </div>
                            <button type="submit" disabled={pin.length !== 4 || checking} className="w-full py-4 bg-orange-500 text-white rounded-xl font-semibold disabled:bg-gray-300 flex items-center justify-center gap-2">
                                {checking ? <><div className="loader" style={{width:20,height:20,borderWidth:2}}></div> Provera...</> : 'Prijava'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const DenominationInput = ({ apoeni, setApoeni, currency = 'RSD' }) => {
            const denoms = currency === 'EUR' ? DENOMINATIONS_EUR : DENOMINATIONS_RSD;
            const total = denoms.reduce((s, d) => s + (d.value * (apoeni[d.value] || 0)), 0);
            return (
                <div className="space-y-2">
                    <p className="font-semibold text-gray-700">Specifikacija ({currency}):</p>
                    {denoms.map(d => (
                        <div key={d.value} className="flex items-center gap-2 bg-white rounded-lg p-2 border">
                            <span className="w-14 font-semibold text-gray-700 text-sm">{d.label}</span><span className="text-gray-400">×</span>
                            <input type="number" min="0" value={apoeni[d.value] || ''} onChange={(e) => setApoeni({...apoeni, [d.value]: parseInt(e.target.value) || 0})} placeholder="0" className="flex-1 p-2 text-center font-semibold border rounded" />
                            <span className="w-20 text-right text-sm text-gray-600">{formatNumber(d.value * (apoeni[d.value] || 0))}</span>
                        </div>
                    ))}
                    <div className="flex justify-between items-center bg-green-100 rounded-lg p-3 mt-3">
                        <span className="font-bold text-green-800">UKUPNO:</span>
                        <span className="font-bold text-xl text-green-800">{formatCurrency(total, currency)}</span>
                    </div>
                </div>
            );
        };

        const DriverHome = ({ user, notify }) => {
            const [view, setView] = useState('home');
            const [apoeni, setApoeni] = useState({});
            const [dostave, setDostave] = useState('');
            const [mesto, setMesto] = useState('');
            const [myShift, setMyShift] = useState(null);
            const [loading, setLoading] = useState(true);

            const loadShift = async () => { const { data } = await supabase.from('shifts').select('*').eq('driver_id', user.id).eq('status', 'active').single(); setMyShift(data); setLoading(false); };
            useEffect(() => { 
                loadShift(); 
                const ch = supabase.channel('driver-shifts-' + user.id)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'shifts' }, (payload) => {
                        console.log('Shift change:', payload);
                        loadShift();
                    })
                    .subscribe((status) => {
                        console.log('Subscription status:', status);
                    }); 
                return () => supabase.removeChannel(ch); 
            }, [user.id]);

            const gotovina = DENOMINATIONS_RSD.reduce((s, d) => s + (d.value * (apoeni[d.value] || 0)), 0);

            const startShift = async () => { setLoading(true); await supabase.from('shifts').insert({ driver_id: user.id, start_time: new Date().toLocaleTimeString('sr-RS', {hour:'2-digit', minute:'2-digit'}), date: new Date().toLocaleDateString('sr-RS'), status: 'active' }); notify('Smena započeta!'); loadShift(); };

            const submitPazar = async () => {
                if (!dostave || !mesto || gotovina === 0) return;
                setLoading(true);
                await supabase.from('submissions').insert({ driver_id: user.id, driver_name: user.name, date: myShift.date, zaduzenje: myShift.zaduzenje, dostave: parseInt(dostave), mesto, gotovina, apoeni, status: 'pending', start_time: myShift.start_time, end_time: new Date().toLocaleTimeString('sr-RS', {hour:'2-digit', minute:'2-digit'}) });
                await supabase.from('shifts').delete().eq('id', myShift.id);
                setView('home'); setApoeni({}); setDostave(''); setMesto('');
                notify('Pazar predat!'); loadShift();
            };

            if (loading) return <LoadingSpinner />;

            if (view === 'razduzenje') {
                return (
                    <div className="p-4 space-y-4">
                        <div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200"><p className="text-sm text-orange-600">E-Bar zaduženje</p><p className="text-3xl font-bold text-orange-700">{formatCurrency(myShift.zaduzenje)}</p></div>
                        <div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">Broj dostava</label><input type="number" value={dostave} onChange={(e) => setDostave(e.target.value)} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl mt-2" /></div>
                        <div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600 mb-3 block">Mesto predaje</label><div className="grid grid-cols-2 gap-2">{DELIVERY_LOCATIONS.map(loc => (<button key={loc.id} onClick={() => setMesto(loc.id)} className={`p-3 rounded-xl border-2 text-sm font-medium ${mesto === loc.id ? 'border-orange-500 bg-orange-50' : 'border-gray-200'}`}>{loc.name}</button>))}</div></div>
                        <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200"><DenominationInput apoeni={apoeni} setApoeni={setApoeni} /></div>
                        {gotovina > 0 && gotovina !== myShift?.zaduzenje && (<div className={`rounded-xl p-4 ${gotovina > myShift?.zaduzenje ? 'bg-blue-100' : 'bg-red-100'}`}><div className="flex justify-between"><span>Razlika:</span><span className="font-bold">{gotovina > myShift?.zaduzenje ? '+' : ''}{formatCurrency(gotovina - myShift?.zaduzenje)}</span></div></div>)}
                        <div className="flex gap-3"><button onClick={() => setView('home')} className="flex-1 py-4 border-2 rounded-xl font-semibold">Otkaži</button><button onClick={submitPazar} disabled={!dostave || !mesto || gotovina === 0} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-semibold disabled:bg-gray-300">✓ Predaj</button></div>
                    </div>
                );
            }

            return (
                <div className="p-4 space-y-4">
                    {!myShift ? (<><div className="bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl p-6"><h2 className="text-2xl font-bold text-gray-700">Nema aktivne smene</h2><p className="text-gray-500">Započnite smenu</p></div><button onClick={startShift} className="w-full bg-green-500 text-white rounded-2xl p-6 flex items-center justify-between"><div className="flex items-center gap-4"><div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center"><Icon name="clock" /></div><p className="font-bold text-lg">Započni smenu</p></div><Icon name="chevronRight" /></button></>) : (<><div className="bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl p-6 text-white"><div className="flex items-center gap-2 mb-2"><Icon name="clock" size={18} /><span className="opacity-80">Od {myShift.start_time}</span></div><h2 className="text-2xl font-bold">Smena aktivna</h2><p className="opacity-80">{myShift.date}</p></div>{!myShift.zaduzenje ? (<div className="bg-yellow-50 rounded-xl p-6 border-2 border-yellow-200"><div className="flex items-center gap-3 text-yellow-700"><Icon name="clock" /><div><p className="font-bold">Čekate zaduženje</p><p className="text-sm">Dispecer će upisati</p></div></div></div>) : (<><div className="bg-green-50 rounded-xl p-4 border-2 border-green-200"><p className="text-sm text-green-600">E-Bar zaduženje</p><p className="text-3xl font-bold text-green-700">{formatCurrency(myShift.zaduzenje)}</p></div><button onClick={() => setView('razduzenje')} className="w-full bg-orange-500 text-white rounded-2xl p-6 flex items-center justify-between"><div className="flex items-center gap-4"><div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center"><Icon name="banknote" /></div><div className="text-left"><p className="font-bold text-lg">Razduži se</p></div></div><Icon name="chevronRight" /></button></>)}</>)}
                </div>
            );
        };

        const DispatcherHome = ({ user, users, notify }) => {
            const [selectedDriver, setSelectedDriver] = useState(null);
            const [zaduzenje, setZaduzenje] = useState('');
            const [shifts, setShifts] = useState([]);
            const [loading, setLoading] = useState(true);
            const drivers = users.filter(u => u.role === 'driver');

            const loadShifts = async () => { const { data } = await supabase.from('shifts').select('*').eq('status', 'active'); setShifts(data || []); setLoading(false); };
            useEffect(() => { 
                loadShifts(); 
                const ch = supabase.channel('dispatcher-shifts')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'shifts' }, (payload) => {
                        console.log('Shifts change:', payload);
                        loadShifts();
                    })
                    .subscribe((status) => {
                        console.log('Dispatcher subscription:', status);
                    }); 
                return () => supabase.removeChannel(ch); 
            }, []);

            const saveZaduzenje = async () => { if (!zaduzenje) return; setLoading(true); const shift = shifts.find(s => s.driver_id === selectedDriver.id); await supabase.from('shifts').update({ zaduzenje: parseInt(zaduzenje) }).eq('id', shift.id); setSelectedDriver(null); setZaduzenje(''); notify('Zaduženje upisano!'); loadShifts(); };

            if (loading) return <LoadingSpinner />;

            if (selectedDriver) {
                const shift = shifts.find(s => s.driver_id === selectedDriver.id);
                return (<div className="p-4 space-y-4"><div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200"><p className="font-bold text-orange-800">{selectedDriver.name}</p><p className="text-sm text-orange-600">Od {shift?.start_time}</p></div><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">E-Bar zaduženje</label><input type="number" value={zaduzenje} onChange={(e) => setZaduzenje(e.target.value)} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl mt-2" /></div><div className="flex gap-3"><button onClick={() => { setSelectedDriver(null); setZaduzenje(''); }} className="flex-1 py-4 border-2 rounded-xl font-semibold">Otkaži</button><button onClick={saveZaduzenje} disabled={!zaduzenje} className="flex-1 py-4 bg-orange-500 text-white rounded-xl font-semibold disabled:bg-gray-300">Sačuvaj</button></div></div>);
            }

            return (<div className="p-4 space-y-4"><div className="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl p-6 text-white"><p className="opacity-80">Vozači na smeni</p><p className="text-3xl font-bold">{shifts.length}</p></div><p className="font-bold text-gray-700">Vozači na smeni:</p>{shifts.length === 0 ? (<div className="bg-gray-50 rounded-xl p-6 text-center text-gray-500">Nema vozača</div>) : shifts.map(shift => { const driver = drivers.find(d => d.id === shift.driver_id); return (<div key={shift.id} className="bg-white rounded-xl p-4 border-2"><div className="flex justify-between items-center"><div><p className="font-semibold">{driver?.name}</p><p className="text-sm text-gray-500">Od {shift.start_time}</p></div><div className="text-right">{shift.zaduzenje ? (<div><p className="font-bold text-green-600">{formatCurrency(shift.zaduzenje)}</p><button onClick={() => { setSelectedDriver(driver); setZaduzenje(shift.zaduzenje.toString()); }} className="text-xs text-blue-500">Izmeni</button></div>) : (<button onClick={() => setSelectedDriver(driver)} className="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-semibold">Upiši</button>)}</div></div></div>); })}</div>);
        };

        const AdminHome = ({ user, users, setUsers, notify }) => {
            const [view, setView] = useState('home');
            const [submissions, setSubmissions] = useState([]);
            const [safeTransactions, setSafeTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [verifying, setVerifying] = useState(null);
            const [adminApoeni, setAdminApoeni] = useState({});
            const [editingUser, setEditingUser] = useState(null);
            const [userForm, setUserForm] = useState({ name: '', pin: '', phone: '', role: 'driver' });
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [txAmount, setTxAmount] = useState('');
            const [txCurrency, setTxCurrency] = useState('RSD');
            const [txSource, setTxSource] = useState('CASH_REGISTER');
            const [txDescription, setTxDescription] = useState('');
            const [controlCurrency, setControlCurrency] = useState('RSD');
            const [controlApoeni, setControlApoeni] = useState({});
            const [controlReason, setControlReason] = useState('');
            const drivers = users.filter(u => u.role === 'driver');

            const loadData = async () => { const [subRes, txRes] = await Promise.all([supabase.from('submissions').select('*').order('created_at', { ascending: false }), supabase.from('safe_transactions').select('*').order('created_at', { ascending: false })]); setSubmissions(subRes.data || []); setSafeTransactions(txRes.data || []); setLoading(false); };
            const loadUsers = async () => { const { data } = await supabase.from('users').select('*').order('role').order('name'); if (data) setUsers(data); };
            useEffect(() => { loadData(); const ch = supabase.channel('adm').on('postgres_changes', { event: '*', schema: 'public', table: 'submissions' }, loadData).on('postgres_changes', { event: '*', schema: 'public', table: 'safe_transactions' }, loadData).on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, loadUsers).subscribe(); return () => supabase.removeChannel(ch); }, []);

            const pending = submissions.filter(s => s.status === 'pending');
            const verified = submissions.filter(s => s.status === 'verified');
            const calcBalance = (c) => safeTransactions.filter(t => t.currency === c).reduce((s, t) => s + (t.type === 'in' ? Number(t.amount) : -Number(t.amount)), 0);
            const safeRSD = calcBalance('RSD'), safeEUR = calcBalance('EUR');

            const handleSaveUser = async () => {
                if (!userForm.name || userForm.pin.length !== 4) { notify('Unesite ime i 4-cifreni PIN', 'error'); return; }
                if (!editingUser || editingUser.pin !== userForm.pin) { const ex = users.find(u => u.pin === userForm.pin && u.id !== editingUser?.id); if (ex) { notify('PIN već postoji!', 'error'); return; } }
                setLoading(true);
                if (editingUser) await supabase.from('users').update({ name: userForm.name, pin: userForm.pin, phone: userForm.phone || null, role: userForm.role }).eq('id', editingUser.id);
                else await supabase.from('users').insert({ name: userForm.name, pin: userForm.pin, phone: userForm.phone || null, role: userForm.role });
                notify(editingUser ? 'Korisnik izmenjen!' : 'Korisnik dodat!');
                setEditingUser(null); setUserForm({ name: '', pin: '', phone: '', role: 'driver' }); setView('users'); loadUsers(); setLoading(false);
            };

            const handleDeleteUser = async () => { if (!deleteConfirm) return; setLoading(true); await supabase.from('users').delete().eq('id', deleteConfirm.id); setDeleteConfirm(null); notify('Korisnik obrisan!'); loadUsers(); setLoading(false); };

            const handleVerify = async (id) => {
                const adminGotovina = DENOMINATIONS_RSD.reduce((s, d) => s + (d.value * (adminApoeni[d.value] || 0)), 0);
                const sub = submissions.find(s => s.id === id);
                setLoading(true);
                await supabase.from('submissions').update({ status: 'verified', admin_gotovina: adminGotovina, admin_apoeni: adminApoeni, verified_by: user.name, verified_at: new Date().toISOString() }).eq('id', id);
                await supabase.from('safe_transactions').insert({ type: 'in', amount: adminGotovina, currency: 'RSD', source: 'DRIVER_DEPOSIT', description: `Predaja: ${sub.driver_name}`, created_by: user.name, related_submission_id: id });
                setVerifying(null); setAdminApoeni({}); notify('Potvrđeno!'); loadData();
            };

            const handleSafeTx = async (type) => {
                if (!txAmount) return; setLoading(true);
                await supabase.from('safe_transactions').insert({ type: type === 'deposit' ? 'in' : 'out', amount: parseFloat(txAmount), currency: txCurrency, source: type === 'deposit' ? txSource : 'WITHDRAWAL', description: txDescription || (type === 'deposit' ? 'Unos' : 'Izuzimanje'), created_by: user.name });
                setTxAmount(''); setTxDescription(''); setView('home'); notify(type === 'deposit' ? 'Dodato!' : 'Izuzeto!'); loadData();
            };

            const handleControl = async () => {
                const denoms = controlCurrency === 'EUR' ? DENOMINATIONS_EUR : DENOMINATIONS_RSD;
                const counted = denoms.reduce((s, d) => s + (d.value * (controlApoeni[d.value] || 0)), 0);
                const expected = calcBalance(controlCurrency);
                const diff = counted - expected;
                setLoading(true);
                await supabase.from('safe_controls').insert({ currency: controlCurrency, expected, counted, difference: diff, apoeni: controlApoeni, reason: controlReason, created_by: user.name });
                if (diff !== 0) await supabase.from('safe_transactions').insert({ type: diff > 0 ? 'in' : 'out', amount: Math.abs(diff), currency: controlCurrency, source: diff > 0 ? 'SURPLUS' : 'SHORTAGE', description: `${diff > 0 ? 'Višak' : 'Manjak'}: ${controlReason}`, created_by: user.name });
                setControlApoeni({}); setControlReason(''); setView('home'); notify(diff === 0 ? 'Tačno!' : 'Sravnjeno!'); loadData();
            };

            if (loading) return <LoadingSpinner />;
            if (deleteConfirm) return <ConfirmModal title="Obriši?" message={`Obrisati "${deleteConfirm.name}"?`} onConfirm={handleDeleteUser} onCancel={() => setDeleteConfirm(null)} />;

            if (view === 'addUser' || view === 'editUser') {
                return (<div className="p-4 space-y-4"><button onClick={() => { setView('users'); setEditingUser(null); setUserForm({ name: '', pin: '', phone: '', role: 'driver' }); }} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button><h2 className="text-xl font-bold">{editingUser ? 'Izmeni' : 'Novi'} korisnik</h2><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">Ime *</label><input type="text" value={userForm.name} onChange={(e) => setUserForm({...userForm, name: e.target.value})} className="w-full p-3 border-2 rounded-xl mt-2" /></div><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">PIN (4 cifre) *</label><input type="text" maxLength={4} value={userForm.pin} onChange={(e) => setUserForm({...userForm, pin: e.target.value.replace(/\D/g, '')})} className="w-full p-3 border-2 rounded-xl mt-2 text-center text-2xl font-mono" /></div><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">Telefon</label><input type="text" value={userForm.phone} onChange={(e) => setUserForm({...userForm, phone: e.target.value})} className="w-full p-3 border-2 rounded-xl mt-2" /></div><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600 mb-3 block">Uloga *</label><div className="space-y-2">{ROLES.map(r => (<button key={r.id} onClick={() => setUserForm({...userForm, role: r.id})} className={`w-full p-3 rounded-xl border-2 flex items-center gap-3 ${userForm.role === r.id ? 'border-orange-500 bg-orange-50' : 'border-gray-200'}`}><div className="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center"><Icon name={r.icon} size={20} /></div><span className="font-medium">{r.name}</span></button>))}</div></div><button onClick={handleSaveUser} disabled={!userForm.name || userForm.pin.length !== 4} className="w-full py-4 bg-green-500 text-white rounded-xl font-semibold disabled:bg-gray-300">✓ Sačuvaj</button></div>);
            }

            if (verifying) {
                const driver = drivers.find(d => d.id === verifying.driver_id);
                const adminGotovina = DENOMINATIONS_RSD.reduce((s, d) => s + (d.value * (adminApoeni[d.value] || 0)), 0);
                const diff = adminGotovina - verifying.gotovina;
                return (<div className="p-4 space-y-4"><div className="bg-orange-50 rounded-xl p-4 border-2 border-orange-200"><p className="font-bold text-orange-800">{driver?.name || verifying.driver_name}</p><p className="text-sm text-orange-600">{verifying.date}</p></div><div className="bg-gray-50 rounded-xl p-4"><p className="font-semibold mb-2">Prijavio:</p><div className="grid grid-cols-2 gap-2 text-sm"><div className="bg-white rounded p-2">Zaduženje: <span className="font-bold">{formatNumber(verifying.zaduzenje)}</span></div><div className="bg-white rounded p-2">Dostave: <span className="font-bold">{verifying.dostave}</span></div><div className="bg-green-50 rounded p-2 col-span-2">Gotovina: <span className="font-bold">{formatNumber(verifying.gotovina)}</span></div></div></div><div className="bg-green-50 rounded-xl p-4 border-2 border-green-200"><DenominationInput apoeni={adminApoeni} setApoeni={setAdminApoeni} /></div>{adminGotovina > 0 && diff !== 0 && (<div className={`rounded-xl p-4 ${diff > 0 ? 'bg-blue-100' : 'bg-red-100'}`}><div className="flex justify-between"><span>Razlika:</span><span className="font-bold">{diff > 0 ? '+' : ''}{formatCurrency(diff)}</span></div></div>)}<div className="flex gap-3"><button onClick={() => { setVerifying(null); setAdminApoeni({}); }} className="flex-1 py-4 border-2 rounded-xl font-semibold">Otkaži</button><button onClick={() => handleVerify(verifying.id)} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-semibold">✓ U sef</button></div></div>);
            }

            if (view === 'addMoney') {
                return (<div className="p-4 space-y-4"><button onClick={() => setView('home')} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button><h2 className="text-xl font-bold">Dodaj u sef</h2><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600 mb-2 block">Izvor</label><div className="space-y-2"><button onClick={() => setTxSource('CASH_REGISTER')} className={`w-full p-3 rounded-xl border-2 text-left ${txSource === 'CASH_REGISTER' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>Sa blagajne</button><button onClick={() => setTxSource('OTHER')} className={`w-full p-3 rounded-xl border-2 text-left ${txSource === 'OTHER' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>Drugo</button></div></div><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600 mb-2 block">Valuta</label><div className="flex gap-2"><button onClick={() => setTxCurrency('RSD')} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${txCurrency === 'RSD' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>RSD</button><button onClick={() => setTxCurrency('EUR')} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${txCurrency === 'EUR' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>EUR</button></div></div><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">Iznos</label><input type="number" value={txAmount} onChange={(e) => setTxAmount(e.target.value)} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl mt-2" /></div><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">Opis</label><input type="text" value={txDescription} onChange={(e) => setTxDescription(e.target.value)} placeholder="opciono" className="w-full p-3 border-2 rounded-xl mt-2" /></div><button onClick={() => handleSafeTx('deposit')} disabled={!txAmount} className="w-full py-4 bg-green-500 text-white rounded-xl font-semibold disabled:bg-gray-300">✓ Dodaj</button></div>);
            }

            if (view === 'withdrawMoney') {
                return (<div className="p-4 space-y-4"><button onClick={() => setView('home')} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button><h2 className="text-xl font-bold">Uzmi iz sefa</h2><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600 mb-2 block">Valuta</label><div className="flex gap-2"><button onClick={() => setTxCurrency('RSD')} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${txCurrency === 'RSD' ? 'border-red-500 bg-red-50' : 'border-gray-200'}`}>RSD ({formatNumber(safeRSD)})</button><button onClick={() => setTxCurrency('EUR')} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${txCurrency === 'EUR' ? 'border-red-500 bg-red-50' : 'border-gray-200'}`}>EUR ({formatNumber(safeEUR)})</button></div></div><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">Iznos</label><input type="number" value={txAmount} onChange={(e) => setTxAmount(e.target.value)} placeholder="0" className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl mt-2" /></div><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">Razlog *</label><input type="text" value={txDescription} onChange={(e) => setTxDescription(e.target.value)} placeholder="obavezno" className="w-full p-3 border-2 rounded-xl mt-2" /></div><button onClick={() => handleSafeTx('withdraw')} disabled={!txAmount || !txDescription} className="w-full py-4 bg-red-500 text-white rounded-xl font-semibold disabled:bg-gray-300">Uzmi</button></div>);
            }

            if (view === 'safeControl') {
                const denoms = controlCurrency === 'EUR' ? DENOMINATIONS_EUR : DENOMINATIONS_RSD;
                const counted = denoms.reduce((s, d) => s + (d.value * (controlApoeni[d.value] || 0)), 0);
                const expected = calcBalance(controlCurrency);
                const diff = counted - expected;
                return (<div className="p-4 space-y-4"><button onClick={() => { setView('home'); setControlApoeni({}); }} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button><h2 className="text-xl font-bold">Kontrola sefa</h2><div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600 mb-2 block">Valuta</label><div className="flex gap-2"><button onClick={() => { setControlCurrency('RSD'); setControlApoeni({}); }} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${controlCurrency === 'RSD' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}`}>RSD</button><button onClick={() => { setControlCurrency('EUR'); setControlApoeni({}); }} className={`flex-1 p-3 rounded-xl border-2 font-semibold ${controlCurrency === 'EUR' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}`}>EUR</button></div></div><div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200"><p className="text-sm text-blue-600">U sistemu</p><p className="text-2xl font-bold text-blue-700">{formatCurrency(expected, controlCurrency)}</p></div><div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200"><DenominationInput apoeni={controlApoeni} setApoeni={setControlApoeni} currency={controlCurrency} /></div>{counted > 0 && (<div className={`rounded-xl p-4 ${diff === 0 ? 'bg-green-100' : diff > 0 ? 'bg-blue-100' : 'bg-red-100'}`}><div className="flex justify-between items-center"><span className="font-semibold">Razlika:</span><span className={`font-bold text-xl ${diff === 0 ? 'text-green-700' : diff > 0 ? 'text-blue-700' : 'text-red-700'}`}>{diff === 0 ? '✓ Tačno' : (diff > 0 ? '+' : '') + formatCurrency(diff, controlCurrency)}</span></div></div>)}{counted > 0 && diff !== 0 && (<div className="bg-white rounded-xl p-4 border-2"><label className="text-sm font-medium text-gray-600">Razlog</label><input type="text" value={controlReason} onChange={(e) => setControlReason(e.target.value)} placeholder="obavezno" className="w-full p-3 border-2 rounded-xl mt-2" /></div>)}<button onClick={handleControl} disabled={counted === 0 || (diff !== 0 && !controlReason)} className="w-full py-4 bg-purple-500 text-white rounded-xl font-semibold disabled:bg-gray-300">{diff === 0 ? '✓ Potvrdi' : '✓ Sravni'}</button></div>);
            }

            if (view === 'reports') {
                const totalIn = safeTransactions.filter(t => t.type === 'in' && t.currency === 'RSD').reduce((s, t) => s + Number(t.amount), 0);
                const totalOut = safeTransactions.filter(t => t.type === 'out' && t.currency === 'RSD').reduce((s, t) => s + Number(t.amount), 0);
                return (<div className="p-4 space-y-4"><button onClick={() => setView('home')} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button><h2 className="text-xl font-bold">Izveštaji</h2><div className="grid grid-cols-2 gap-3"><div className="bg-green-50 rounded-xl p-4 border-2 border-green-200"><p className="text-sm text-green-600">Ulaz</p><p className="text-xl font-bold text-green-700">{formatCurrency(totalIn)}</p></div><div className="bg-red-50 rounded-xl p-4 border-2 border-red-200"><p className="text-sm text-red-600">Izlaz</p><p className="text-xl font-bold text-red-700">{formatCurrency(totalOut)}</p></div></div><div className="bg-white rounded-xl border-2 overflow-hidden"><div className="bg-gray-50 p-3 border-b font-bold">Transakcije ({safeTransactions.length})</div><div className="max-h-96 overflow-y-auto">{safeTransactions.map(tx => (<div key={tx.id} className="p-3 border-b last:border-b-0 flex justify-between items-center"><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${tx.type === 'in' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}><Icon name={tx.type === 'in' ? 'arrowDown' : 'arrowUp'} size={16} /></div><div><p className="font-medium text-sm">{tx.description}</p><p className="text-xs text-gray-500">{formatDateTime(tx.created_at)}</p></div></div><p className={`font-bold ${tx.type === 'in' ? 'text-green-600' : 'text-red-600'}`}>{tx.type === 'in' ? '+' : '-'}{formatCurrency(tx.amount, tx.currency)}</p></div>))}{safeTransactions.length === 0 && <p className="p-4 text-center text-gray-500">Nema</p>}</div></div></div>);
            }

            if (view === 'users') {
                const grouped = { driver: users.filter(u => u.role === 'driver'), dispatcher: users.filter(u => u.role === 'dispatcher'), admin: users.filter(u => u.role === 'admin') };
                return (<div className="p-4 space-y-4"><button onClick={() => setView('home')} className="flex items-center gap-2 text-gray-500"><Icon name="arrowLeft" size={20} /> Nazad</button><div className="flex justify-between items-center"><h2 className="text-xl font-bold">Korisnici ({users.length})</h2><button onClick={() => { setUserForm({ name: '', pin: '', phone: '', role: 'driver' }); setEditingUser(null); setView('addUser'); }} className="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold flex items-center gap-2"><Icon name="userPlus" size={18} /> Novi</button></div>{ROLES.map(role => (<div key={role.id}><p className="font-bold text-gray-500 text-sm uppercase mb-2">{role.name}i ({grouped[role.id].length})</p>{grouped[role.id].map(u => (<div key={u.id} className="bg-white rounded-xl p-4 border-2 mb-2 flex justify-between items-center"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center"><Icon name={role.icon} size={20} /></div><div><p className="font-semibold">{u.name}</p><p className="text-sm text-gray-500">{u.phone || '-'}</p></div></div><div className="flex items-center gap-2"><span className="px-2 py-1 bg-gray-100 rounded font-mono text-sm">{u.pin}</span><button onClick={() => { setEditingUser(u); setUserForm({ name: u.name, pin: u.pin, phone: u.phone || '', role: u.role }); setView('editUser'); }} className="p-2 text-blue-500"><Icon name="edit" size={18} /></button><button onClick={() => setDeleteConfirm(u)} className="p-2 text-red-500" disabled={u.id === user.id}><Icon name="trash" size={18} /></button></div></div>))}</div>))}</div>);
            }

            return (<div className="p-4 space-y-4"><div className="bg-gradient-to-r from-orange-500 to-red-600 rounded-2xl p-5 text-white"><p className="text-sm opacity-80">INTERNI SEF</p><p className="text-3xl font-bold">{formatCurrency(safeRSD)}</p>{safeEUR > 0 && <p className="text-lg opacity-80">{formatCurrency(safeEUR, 'EUR')}</p>}</div><div className="grid grid-cols-2 gap-3"><button onClick={() => setView('addMoney')} className="bg-green-500 text-white rounded-2xl p-4 flex flex-col items-center"><Icon name="plus" /><p className="font-semibold mt-2 text-sm">Dodaj</p></button><button onClick={() => setView('withdrawMoney')} className="bg-red-500 text-white rounded-2xl p-4 flex flex-col items-center"><Icon name="minus" /><p className="font-semibold mt-2 text-sm">Uzmi</p></button><button onClick={() => setView('safeControl')} className="bg-purple-500 text-white rounded-2xl p-4 flex flex-col items-center"><Icon name="clipboardCheck" /><p className="font-semibold mt-2 text-sm">Kontrola</p></button><button onClick={() => setView('reports')} className="bg-blue-500 text-white rounded-2xl p-4 flex flex-col items-center"><Icon name="fileText" /><p className="font-semibold mt-2 text-sm">Izveštaji</p></button></div><button onClick={() => setView('users')} className="w-full bg-gray-100 rounded-xl p-4 flex items-center justify-between"><div className="flex items-center gap-3"><Icon name="users" /><span className="font-semibold">Korisnici ({users.length})</span></div><Icon name="chevronRight" /></button><div className="grid grid-cols-2 gap-2"><div className="rounded-xl p-3 bg-orange-100 border-2 border-orange-300"><p className="text-2xl font-bold text-orange-600">{pending.length}</p><p className="text-xs">Za proveru</p></div><div className="rounded-xl p-3 bg-green-100 border-2 border-green-300"><p className="text-2xl font-bold text-green-600">{verified.length}</p><p className="text-xs">Potvrđeno</p></div></div>{pending.length > 0 && <p className="font-bold text-gray-700">Za proveru:</p>}{pending.map(sub => { const driver = drivers.find(d => d.id === sub.driver_id); const mesto = DELIVERY_LOCATIONS.find(l => l.id === sub.mesto); return (<div key={sub.id} className="bg-white rounded-xl p-4 border-2 border-orange-200"><div className="flex justify-between mb-3"><div><p className="font-semibold">{driver?.name || sub.driver_name}</p><p className="text-sm text-gray-500">{sub.date} • {mesto?.name}</p></div><p className="font-bold text-lg text-green-700">{formatCurrency(sub.gotovina)}</p></div><div className="flex gap-2 text-xs mb-3"><span className="bg-gray-100 px-2 py-1 rounded">{sub.dostave} dostava</span><span className="bg-gray-100 px-2 py-1 rounded">{sub.start_time}-{sub.end_time}</span></div><button onClick={() => { setVerifying(sub); setAdminApoeni(sub.apoeni || {}); }} className="w-full py-3 bg-orange-500 text-white rounded-lg font-semibold">Proveri</button></div>); })}</div>);
        };

        function App() {
            const [user, setUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [online, setOnline] = useState(true);
            const [notif, setNotif] = useState(null);

            useEffect(() => { const load = async () => { const { data, error } = await supabase.from('users').select('*'); if (error) setOnline(false); else { setUsers(data || []); setOnline(true); } setLoading(false); }; load(); }, []);
            const notify = (msg, type='success') => { setNotif({msg, type}); setTimeout(() => setNotif(null), 3000); };
            if (!user) return <LoginScreen onLogin={setUser} loading={loading} />;
            const titles = { driver: 'Vozač', dispatcher: 'Dispecer', admin: 'Administracija' };

            return (<div className="min-h-screen bg-gray-100">{notif && <Notification message={notif.msg} type={notif.type} onClose={() => setNotif(null)} />}<Header user={user} onLogout={() => setUser(null)} title={titles[user.role]} online={online} /><div className="max-w-lg mx-auto pb-8">{user.role === 'driver' && <DriverHome user={user} notify={notify} />}{user.role === 'dispatcher' && <DispatcherHome user={user} users={users} notify={notify} />}{user.role === 'admin' && <AdminHome user={user} users={users} setUsers={setUsers} notify={notify} />}</div></div>);
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
